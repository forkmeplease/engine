config:
  snippets:
    pipelineStages:
      - cri: { }

      # Try to parse JSON: extract level/severity if present.
      # If not JSON, just skip silently
      - json:
          expressions:
            level: level
            severity: severity

      # Promote whatever we found so far to a Loki label
      - labels:
          level:

      - match:
          selector: '{level=""}'
          stages:
            - regex:
                expression: '.*(?:level|severity)[=:]\s*"?(?P<level>info)"?.*'
            - labels:
                level:

      # Promote whatever we found so far to a Loki label
      - labels:
          level:

      # Detect error patterns in raw log text and set level=error
      - match:
          selector: '{level!="info"} |~ "(?i)\\b(emerg|fatal|alert|crit(?:ical)?|err|eror|error|panic|exception)\\b"'
          stages:
            - static_labels:
                level: error

      #  Count all logs labeled as errors (from JSON or pattern matching)
      - match:
          selector: '{level="error"}'
          stages:
            - metrics:
                q_log_errors_total:
                  type: Counter
                  description: "Lines classified as error"
                  config:
                    match_all: true
                    action: inc


serviceMonitor:
  enabled: true
  interval: 30s
  labels:
    release: prometheus
